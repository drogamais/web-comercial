<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Web Comercial{% endblock %}</title>
    
    <link rel="icon" href="{{ url_for('static', filename='core/images/logo_drogamais.ico') }}" type="image/x-icon">

    <link rel="stylesheet" href="{{ url_for('static', filename='core/css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='core/css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='core/css/modal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='core/css/alert.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='core/css/forms.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='core/css/tables.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="/htmx.min.js"></script>
    {% block styles %}{% endblock %}
</head>
<body>
    <span class="htmx-indicator" style="position:fixed; top:10px; right:10px; font-weight:bold; color:#007bff; z-index:9999; background:white; padding: 5px 10px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.2);">
        Carregando...
    </span>

    {% include "sidebar.html" %}

    <div id="assunto-modal" class="modal-overlay">
        </div>

    <main class="main-content">
        <div class="container" id="main-content">
            {% block content %}{% endblock %}
        </div>
    </main>

    <script src="{{ url_for('static', filename='core/js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='core/js/sidebar.js') }}"></script>

    {% block scripts %}{% endblock %}
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.App && App.main && App.main.init) {
                // App.main.init(); // Esta lógica será movida
            }
            
            // Dispara a inicialização de todos os scripts pela primeira vez
            // (Os próprios scripts agora se registram em 'window')
            if (window.initSidebar) window.initSidebar();
            if (window.initDragAndDrop) window.initDragAndDrop();
            if (window.initSelectAll) window.initSelectAll();
            if (window.initCampanhasListPage) window.initCampanhasListPage();
            if (window.initProdutosCampanhaPage) window.initProdutosCampanhaPage();
            if (window.initTabloideListPage) window.initTabloideListPage();
            if (window.initProdutosTabloidePage) window.initProdutosTabloidePage();
            if (window.initParceirosPage) window.initParceirosPage();
            if (window.initIndexPage) window.initIndexPage();
        });

        // **** NOVO: Listener Global do HTMX ****
        // Isso é crucial. Ele re-inicializa os scripts em qualquer
        // conteúdo que o HTMX acabou de carregar.
        document.body.addEventListener('htmx:afterSwap', function(event) {
            // Re-inicializa scripts globais
            if (window.initSidebar) window.initSidebar();
            if (window.initDragAndDrop) window.initDragAndDrop();
            if (window.initSelectAll) window.initSelectAll();
            
            // Re-inicializa scripts específicos da página (eles
            // verificarão internamente se os elementos necessários existem)
            if (window.initCampanhasListPage) window.initCampanhasListPage();
            if (window.initProdutosCampanhaPage) window.initProdutosCampanhaPage();
            if (window.initTabloideListPage) window.initTabloideListPage();
            if (window.initProdutosTabloidePage) window.initProdutosTabloidePage();
            if (window.initParceirosPage) window.initParceirosPage();
            if (window.initIndexPage) window.initIndexPage();
        });
    </script>
</body>
</html>