{% extends "campanha/base_campanha.html" %}

{% block title %}Produtos da Campanha{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/page-campanhas.css') }}">
{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Gerenciar Produtos da Campanha: {{ campanha.nome }}</h1>
        <a href="{{ url_for('campanha.download_modelo') }}" class="button-filter" style="margin: 0; max-width: 250px; text-decoration: none;">
            &#x2B07; Baixar Modelo da Planilha
        </a>

        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button type="button" id="btn-export-excel" class="button-filter" style="flex: 1; background-color: #27ae60;">
                Exportar Excel (.xlsx)
            </button>   
        </div>
    </div>
    <a href="{{ url_for('campanha.gestao_campanhas') }}" style="display: inline-block; margin-bottom: 20px;">&larr; Voltar para Campanhas</a>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h2>Produtos Cadastrados</h2>
    {% if produtos %}
    <form method="post" id="form-edit-delete">
        <table>
            <thead>
                <tr>
                    <th style="width: 5%; text-align: center;">
                         <input type="checkbox" id="select-all-checkbox" title="Selecionar Todos">
                    </th>
                    <th style="width: 15%;">Cód. Barras</th>
                    <th>Descrição</th>
                    <th style="width: 8%;">Pontos</th>
                    <th style="width: 10%;">Preço Normal</th>
                    <th style="width: 10%;">Preço Desconto</th>
                    <th style="width: 10%;">Rebaixe</th>
                    <th style="width: 8%;">Qtd. Limite</th>
                </tr>
            </thead>
            <tbody>
                {% for p in produtos %}
                <tr>
                    <td style="text-align: center;">
                        <input type="checkbox" name="selecionado" value="{{ p.id }}" class="edit-checkbox">
                    </td>
                    <td><input type="text" name="codigo_barras_{{ p.id }}" value="{{ p.codigo_barras or '' }}" disabled class="barcode-input"></td>
                    <td class="assunto-cell"><input type="text" name="descricao_{{ p.id }}" value="{{ p.descricao or '' }}" disabled></td>
                    <td><input type="number" step="1" name="pontuacao_{{ p.id }}" value="{{ p.pontuacao or '' }}" disabled></td>
                    <td><input type="number" step="0.01" name="preco_normal_{{ p.id }}" value="{{ p.preco_normal or '' }}" disabled></td>
                    <td><input type="number" step="0.01" name="preco_desconto_{{ p.id }}" value="{{ p.preco_desconto or '' }}" disabled></td>
                    <td><input type="number" step="0.01" name="rebaixe_{{ p.id }}" value="{{ p.rebaixe or '' }}" disabled></td>
                    <td><input type="number" step="1" name="qtd_limite_{{ p.id }}" value="{{ p.qtd_limite or '' }}" disabled></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button type="submit" formaction="{{ url_for('campanha_produtos.atualizar_produtos', campanha_id=campanha.id) }}" style="flex: 1;">Salvar Alterações</button>
            
            <button type="button" id="btn-validar-formato" class="button-filter" style="flex: 1;">
                Validar Formato (Local)
            </button>

            <button type="button" id="btn-validar-gtins" class="button-filter" style="flex: 1; background-color: #f39c12;">
                Validar GTINs
            </button>

            <button type="button" id="btn-limpar-validacoes" class="button-filter" style="flex: 1; background-color: #d1f312;">
                Limpar Validações
            </button>
            
            <button type="submit" formaction="{{ url_for('campanha_produtos.deletar_produtos', campanha_id=campanha.id) }}" class="button-danger" style="flex: 1; margin: 0; max-width: none;" onclick="return confirm('Tem certeza que deseja deletar os produtos selecionados?');">Deletar Selecionados</button>
        </div>
    </form>
    {% else %}
    <p>Nenhum produto foi cadastrado para esta campanha ainda.</p>
    {% endif %}

    <hr style="margin: 40px 0;">

    <h2>Adicionar Novo Produto</h2>
    <div class="filter-container">
        <form action="{{ url_for('campanha_produtos.adicionar_produto', campanha_id=campanha.id) }}" method="post" class="filter-form">
            <div class="form-group" style="flex: 1.5;">
                <label>Cód. Barras:</label>
                <input type="text" name="codigo_barras">
            </div>
            <div class="form-group" style="flex: 3;">
                <label>Descrição:</label>
                <input type="text" name="descricao">
            </div>
            <div class="form-group" style="flex: 0.8;">
                <label>Pontos:</label>
                <input type="number" step="1" name="pontuacao">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Preço Normal:</label>
                <input type="number" step="0.01" name="preco_normal">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Preço Desconto:</label>
                <input type="number" step="0.01" name="preco_desconto">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Rebaixe:</label>
                <input type="number" step="0.01" name="rebaixe">
            </div>
            <div class="form-group" style="flex: 0.8;">
                <label>Qtd. Limite:</label>
                <input type="number" step="1" name="qtd_limite">
            </div>
            <button type="submit" class="button-filter">Adicionar</button>
        </form>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="{{ url_for('static', filename='js/productTableUtils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/produtosCampanhaPage.js') }}"></script>
    <script src="{{ url_for('static', filename='js/selectAll.js') }}"></script>
{% endblock %}