{% extends "parceiro/base_parceiros.html" %}

{% block title %}Gerenciar Parceiros{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='parceiro/css/page-parceiros.css') }}">
{% endblock %}

{% block content %}
    <h1>Gerenciar Parceiros</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="filter-container" style="margin-top: 20px;">
        <h2>Novo Parceiro</h2>
        <form action="{{ url_for('parceiro.gestao_parceiros') }}" method="post" class="filter-form" style="align-items: flex-start;">
            
            <div class="form-group" style="flex: 1.5 1 350px;">
                <label for="nome_ajustado">Nome Ajustado: <span style="color: red;">*</span></label>
                <input type="text" id="nome_ajustado" name="nome_ajustado" required>
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label for="tipo">Tipo: <span style="color: red;">*</span></label>
                <select id="tipo" name="tipo" required>
                    <option value="" selected>Selecione...</option>
                    <option value="INDUSTRIA">INDUSTRIA</option>
                    <option value="DISTRIBUIDOR">DISTRIBUIDOR</option>
                </select>
            </div>

            <div class="form-group" style="flex: 1 1 150px;">
                <label for="cnpj">CNPJ: <span style="color: red;">*</span></label>
                <input type="text" id="cnpj" name="cnpj" required>
            </div>
            
            <div class="form-group" style="flex: 1.5 1 300px;">
                <label for="nome_fantasia">Nome Fantasia:</label>
                <input type="text" id="nome_fantasia" name="nome_fantasia">
            </div>
            
            <div class="form-group" style="flex: 1.5 1 300px;">
                <label for="razao_social">Razão Social: <span style="color: red;">*</span></label>
                <input type="text" id="razao_social" name="razao_social" required>
            </div>
            
            <div class="form-group" style="flex: 1 1 250px;">
                <label for="gestor">Gestor:</label>
                <input type="text" id="gestor" name="gestor">
            </div>
            
            <div class="form-group" style="flex: 1 1 200px;">
                <label for="telefone_gestor">Telefone Gestor:</label>
                <input type="text" id="telefone_gestor" name="telefone_gestor">
            </div>
            
            <div class="form-group" style="flex: 1.5 1 200px;">
                <label for="email_gestor">E-mail Gestor:</label>
                <input type="email" id="email_gestor" name="email_gestor">
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label for="data_entrada">Data Entrada: <span style="color: red;">*</span></label>
                <input type="date" id="data_entrada" name="data_entrada" required>
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label for="data_saida">Data Saída: <span style="color: red;">*</span></label>
                <input type="date" id="data_saida" name="data_saida" required>
            </div> 
            
            <div class="form-group" style="flex: 1; justify-content: flex-end; align-self: flex-end;">
                <button type="submit" style="height: 38px;">Criar Parceiro</button>
            </div>
        </form>
    </div>
    
    <div class="filter-container">
        <h2>Filtrar Parceiros</h2>
        <form action="{{ url_for('parceiro.gestao_parceiros') }}" method="get" class="filter-form" style="align-items: flex-end; gap: 10px;" autocomplete="off">
            
            <div class="form-group" style="flex: 1; min-width: 150px;">
                <label for="tipo_filtro">Tipo:</label>
                <select id="tipo_filtro" name="tipo">
                    <option value="" {{ 'selected' if tipo_filtro == '' or tipo_filtro is none else '' }}>Todos</option>
                    <option value="INDUSTRIA" {{ 'selected' if tipo_filtro == 'INDUSTRIA' else '' }}>INDUSTRIA</option>
                    <option value="DISTRIBUIDOR" {{ 'selected' if tipo_filtro == 'DISTRIBUIDOR' else '' }}>DISTRIBUIDOR</option>
                </select>
            </div>

            <div class="form-group" style="flex: 1; min-width: 150px;">
                <label for="status_filtro">Status:</label>
                <select id="status_filtro" name="status">
                    <option value="" {{ 'selected' if status_filtro == '' or status_filtro is none else '' }}>Todos</option>
                    <option value="1" {{ 'selected' if status_filtro == '1' else '' }}>ATIVO</option>
                    <option value="0" {{ 'selected' if status_filtro == '0' else '' }}>INATIVO</option>
                </select>
            </div>
            
            <div class="form-group" style="flex: 1; min-width: 100px;">
                <label for="data_entrada_min">Data Entrada (Min):</label>
                <input type="date" id="data_entrada_min" name="data_entrada_min" value="{{ data_entrada_min_filtro or '' }}">
            </div>
            
            <div class="form-group" style="flex: 1; min-width: 100px;">
                <label for="data_saida_max">Data Saída (Max):</label>
                <input type="date" id="data_saida_max" name="data_saida_max" value="{{ data_saida_max_filtro or '' }}">
            </div>
            
            <div class="form-group" style="flex: 0.8; min-width: 120px;">
                <button type="submit" class="button-filter" style="height: 38px;">Aplicar Filtro</button>
            </div>
        </form>
    </div>

    <h2>Parceiros Cadastrados</h2>
    {% if parceiros %}
    <table style="table-layout: auto;">
        <thead>
            <tr>
                <th style="width: 25%;">Nome Ajustado</th>
                <th style="width: 15%;">CNPJ</th>
                <th style="width: 15%;">Tipo</th>
                <th style="width: 20%;" class="th-parceiro-acoes">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for p in parceiros %}
            <tr>
                <td>{{ p.nome_ajustado }}</td>
                <td>{{ p.cnpj }}</td>
                <td>{{ p.tipo }}</td>
                <td>
                    <div class="action-buttons-container">
                        <button type="button" class="btn-edit button-filter btn-editar-parceiro"
                                data-id="{{ p.id }}"
                                data-nome-ajustado="{{ p.nome_ajustado }}"
                                data-tipo="{{ p.tipo }}"
                                data-cnpj="{{ p.cnpj }}"
                                data-nome-fantasia="{{ p.nome_fantasia or '' }}"
                                data-razao-social="{{ p.razao_social }}"
                                data-gestor="{{ p.gestor or '' }}"
                                data-telefone-gestor="{{ p.telefone_gestor or '' }}"
                                data-email-gestor="{{ p.email_gestor or '' }}"
                                data-data-entrada="{{ p.data_entrada.strftime('%Y-%m-%d') if p.data_entrada else '' }}"
                                data-data-saida="{{ p.data_saida.strftime('%Y-%m-%d') if p.data_saida else '' }}">
                            Editar
                        </button>

                        <button type="button" class="button-danger btn-delete btn-deletar-parceiro"
                                data-id="{{ p.id }}"
                                data-nome-ajustado="{{ p.nome_ajustado }}">
                            Excluir 
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>Nenhum parceiro cadastrado ainda.</p>
    {% endif %}

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;"> <h2>Editar Parceiro</h2>
            <form id="edit-form" method="post" class="filter-form" style="align-items: flex-start;">

                <div class="form-group" style="flex: 1.5;">
                    <label for="nome_ajustado_edit">Nome Ajustado: <span style="color: red;">*</span></label>
                    <input type="text" id="nome_ajustado_edit" name="nome_ajustado_edit" required>
                </div>

                <div class="form-group" style="flex: 1;">
                    <label for="tipo_edit">Tipo: <span style="color: red;">*</span></label>
                    <select id="tipo_edit" name="tipo_edit" required>
                        <option value="" disabled>Selecione...</option>
                        <option value="INDUSTRIA">INDUSTRIA</option>
                        <option value="DISTRIBUIDOR">DISTRIBUIDOR</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1;">
                    <label for="cnpj_edit">CNPJ: <span style="color: red;">*</span></label>
                    <input type="text" id="cnpj_edit" name="cnpj_edit" required>
                </div>

                <div class="form-group" style="flex: 1.5;">
                    <label for="nome_fantasia_edit">Nome Fantasia:</label>
                    <input type="text" id="nome_fantasia_edit" name="nome_fantasia_edit">
                </div>

                <div class="form-group" style="flex: 1.5;">
                    <label for="razao_social_edit">Razão Social: <span style="color: red;">*</span></label>
                    <input type="text" id="razao_social_edit" name="razao_social_edit" required>
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label for="gestor_edit">Gestor:</label>
                    <input type="text" id="gestor_edit" name="gestor_edit">
                </div>

                <div class="form-group" style="flex: 1;">
                    <label for="telefone_gestor_edit">Telefone Gestor:</label>
                    <input type="text" id="telefone_gestor_edit" name="telefone_gestor_edit">
                </div>

                <div class="form-group" style="flex: 1.5;">
                    <label for="email_gestor_edit">E-mail Gestor:</label>
                    <input type="email" id="email_gestor_edit" name="email_gestor_edit">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="data_entrada_edit">Data Entrada: <span style="color: red;">*</span></label>
                    <input type="date" id="data_entrada_edit" name="data_entrada_edit" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="data_saida_edit">Data Saída: <span style="color: red;">*</span></label>
                    <input type="date" id="data_saida_edit" name="data_saida_edit" required>
                </div>
                
                <div class="modal-actions" style="flex-basis: 100%; margin-top: 25px;">
                    <button id="modal-btn-cancel" type="button" class="modal-button-cancel">Cancelar</button>
                    <button type="submit" class="modal-button-confirm">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Confirmar Exclusão</h2> 
            
            <p>Para habilitar a confirmação, digite o nome ajustado exato do parceiro no campo abaixo:</p>

            <p class="delete-modal-parceiro-name-label">Nome Ajustado: <strong id="delete-modal-parceiro-name"></strong></p>

            <form id="delete-form" method="post" action="">
                <div class="form-group" style="text-align: left; margin-top: 15px;">
                    <label for="delete-modal-input">Digite o nome para confirmar:</label>
                    <input type="text" id="delete-modal-input" name="confirmation_text" autocomplete="off">
                </div>
                
                <div class="form-group" style="text-align: left; margin-top: 15px;">
                    <label for="delete-modal-password">Senha de Confirmação:</label>
                    <input type="password" id="delete-modal-password" name="confirmation_password" autocomplete="off">
                </div>

                <p class="delete-modal-info-text">(Isso irá excluir permanentemente o parceiro.)</p>
                
                <div class="modal-actions" style="margin-top: 25px;">
                    <button id="delete-modal-btn-cancel" type="button" class="modal-button-cancel">Cancelar</button>
                    <button id="delete-modal-btn-confirm" type="submit" class="modal-button-danger" disabled>Confirmar</button>
                </div>
            </form>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='parceiro/js/parceirosPage.js') }}"></script>
{% endblock %}