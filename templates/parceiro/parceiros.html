{% extends "parceiro/base_parceiros.html" %}

{% block title %}Gerenciar Parceiros{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='parceiro/css/page-parceiros.css') }}">
{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Gerenciar Parceiros</h1>
        
        <div>
            <a href="{{ url_for('parceiro.exportar_parceiros', 
                        tipo=tipo_filtro or '', 
                        nome_fantasia=nome_fantasia_filtro or '', 
                        data_entrada_min=data_entrada_min_filtro or '', 
                        data_saida_max=data_saida_max_filtro or '',
                        sort_expiring='1' if sort_expiring_filtro else '') }}" 
                class="button-filter" 
                style="background-color: #27ae60; text-decoration: none; max-width: 250px; margin: 0;">
                &#x2B07; Exportar Parceiros (Excel)
            </a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="filter-container" style="margin-top: 20px;">
        <h2>Novo Parceiro</h2>
        <form action="{{ url_for('parceiro.gestao_parceiros') }}" method="post" class="filter-form" style="align-items: flex-start;" id="create-parceiro-form" enctype="multipart/form-data">
            
            <div class="form-group" style="flex: 1.5 1 300px;">
                <label for="nome_fantasia">Nome Fantasia: <span style="color: red;">*</span></label>
                <input type="text" id="nome_fantasia" name="nome_fantasia" required>
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label for="tipo">Tipo: <span style="color: red;">*</span></label>
                <select id="tipo" name="tipo" required>
                    <option value="" selected>Selecione...</option>
                    <option value="INDUSTRIA">INDUSTRIA</option>
                    <option value="DISTRIBUIDOR">DISTRIBUIDOR</option>
                </select>
            </div>
            
            <div class="form-group" style="flex: 1 1 150px;">
                <label for="cnpj">CNPJ: <span style="color: red;">*</span></label>
                <input type="text" id="cnpj" name="cnpj" required>
            </div>
            
            <div class="form-group" style="flex: 1.5 1 350px;">
                <label for="nome_ajustado">Nome Ajustado: <span style="color: red;">*</span></label>
                
                <input type="text" id="nome_ajustado" name="nome_ajustado" required 
                    list="datalist_nomes" autocomplete="off" 
                    placeholder="Digite ou selecione...">              
            </div>
            
            <div class="form-group" style="flex: 1.5 1 300px;">
                <label for="razao_social">Razão Social: <span style="color: red;">*</span></label>
                <input type="text" id="razao_social" name="razao_social" required>
            </div>
            
            <div class="form-group" style="flex: 1 1 250px;">
                <label for="gestor">Gestor: <span style="color: red;">*</span></label>
                <input type="text" id="gestor" name="gestor" required>
            </div>
            
            <div class="form-group" style="flex: 1 1 200px;">
                <label for="telefone_gestor">Telefone Gestor: <span style="color: red;">*</span></label>
                <input type="text" id="telefone_gestor" name="telefone_gestor" required>
            </div>
            
            <div class="form-group" style="flex: 1.5 1 200px;">
                <label for="email_gestor">E-mail Gestor: <span style="color: red;">*</span></label>
                <input type="email" id="email_gestor" name="email_gestor" required>
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label for="data_entrada">Data Entrada: </label>
                <input type="date" id="data_entrada" name="data_entrada">
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label for="data_saida">Data Saída: </label>
                <input type="date" id="data_saida" name="data_saida">
            </div>

            <div class="form-group" style="flex: 1 1 200px;">
                <label for="contrato_arquivo">Contrato (PDF):</label>
                <input type="file" id="contrato_arquivo" name="contrato_arquivo" accept=".pdf">
            </div>
            
            <div class="form-group" style="flex: 1; justify-content: flex-end; align-self: flex-end;">
                <button type="button" id="btn-show-create-modal" style="height: 38px;">Criar Parceiro</button>
            </div>
        </form>
    </div>
    
    <div class="filter-container">
        <h2>Filtrar Parceiros</h2>
        <form action="{{ url_for('parceiro.gestao_parceiros') }}" method="get" class="filter-form" style="align-items: flex-end; gap: 10px;" autocomplete="off">
            
            <div class="form-group" style="flex: 1.2; min-width: 180px;">
                <label for="nome_fantasia_filtro">Nome Fantasia:</label>
                <input type="text" id="nome_fantasia_filtro" name="nome_fantasia" value="{{ nome_fantasia_filtro or '' }}" autocomplete="off">
            </div>
            
            <div class="form-group" style="flex: 0.8; min-width: 150px;">
                <label for="tipo_filtro">Tipo:</label>
                <select id="tipo_filtro" name="tipo">
                    <option value="" {{ 'selected' if tipo_filtro == '' or tipo_filtro is none else '' }}>Todos</option>
                    <option value="INDUSTRIA" {{ 'selected' if tipo_filtro == 'INDUSTRIA' else '' }}>INDUSTRIA</option>
                    <option value="DISTRIBUIDOR" {{ 'selected' if tipo_filtro == 'DISTRIBUIDOR' else '' }}>DISTRIBUIDOR</option>
                </select>
            </div>

            <div class="form-group" style="flex: 0.8; min-width: 100px;">
                <label for="data_entrada_min">Data Entrada (Min):</label>
                <input type="date" id="data_entrada_min" name="data_entrada_min" value="{{ data_entrada_min_filtro or '' }}">
            </div>
            
            <div class="form-group" style="flex: 0.8; min-width: 100px;">
                <label for="data_saida_max">Data Saída (Max):</label>
                <input type="date" id="data_saida_max" name="data_saida_max" value="{{ data_saida_max_filtro or '' }}">
            </div>

            <div class="form-group" style="flex: 1.2; min-width: 150px;">
                <label for="sort_expiring_filtro">Ordenar por:</label>
                <select id="sort_expiring_filtro" name="sort_expiring">
                    <option value="0" {{ 'selected' if not sort_expiring_filtro else '' }}>Nome (Padrão)</option>
                    <option value="1" {{ 'selected' if sort_expiring_filtro else '' }}>Vencimento (Mais Próximo)</option>
                </select>
            </div>
            
            <div class="form-group" style="flex: 0.8; min-width: 120px;">
                <button type="submit" class="button-filter" style="height: 38px;">Aplicar Filtro</button>
            </div>

            <div class="form-group" style="flex: 0.8; min-width: 120px; height: 38px">
                <a href="{{ url_for('parceiro.gestao_parceiros') }}" 
                   class="button-filter" 
                   style="height: 38px; background-color: #7f8c8d; text-decoration: none; display: flex; align-items: center; justify-content: center;">
                   Limpar Filtros
                </a>
            </div>   
        </form>
    </div>

    <h2>Parceiros Cadastrados</h2>
    {% if parceiros %}
    <table style="table-layout: auto;">
        <thead>
            <tr>
                <th style="width: 22%;">Nome Fantasia</th>
                <th style="width: 18%;">Email Gestor</th>
                <th style="width: 12%;">Tipo</th>

                <th style="width: 6%; text-align: center;">Senha Definida?</th>

                <th style="width: 20%;" class="th-parceiro-acoes">Ações</th>
                <th style="width: 5%; text-align: center;">Contrato</th>
            </tr>
        </thead>
        <tbody>
            {% for p in parceiros %}
            <tr {% if p.id in expiring_ids_set %}class="row-expiring"{% endif %}>
                <td>{{ p.nome_fantasia }}</td>
                <td>{{ p.email_gestor }}</td>
                <td>{{ p.tipo }}</td>

                <td style="text-align: center; font-size: 1.2em; font-weight: bold;">
                    {% if p.senha_definida == 1 %}
                        <span style="color: #27ae60;" title="Senha definida">✓</span>
                    {% else %}
                        <span style="color: #e74c3c;" title="Senha NÃO definida">✗</span>
                    {% endif %}
                </td>

                <td>
                    <div class="action-buttons-container">
                        <button type="button" class="btn-edit button-filter btn-editar-parceiro"
                                data-id="{{ p.id }}"
                                data-nome-ajustado="{{ p.nome_ajustado }}"
                                data-tipo="{{ p.tipo }}"
                                data-cnpj="{{ p.cnpj }}"
                                data-nome-fantasia="{{ p.nome_fantasia or '' }}"
                                data-razao-social="{{ p.razao_social }}"
                                data-gestor="{{ p.gestor or '' }}"
                                data-telefone-gestor="{{ p.telefone_gestor or '' }}"
                                data-email-gestor="{{ p.email_gestor or '' }}"
                                data-data-entrada="{{ p.data_entrada.strftime('%Y-%m-%d') if p.data_entrada else '' }}"
                                data-data-saida="{{ p.data_saida.strftime('%Y-%m-%d') if p.data_saida else '' }}"
                                data-contrato-arquivo="{{ p.contrato_arquivo or '' }}">
                            Editar
                        </button>

                        <button type="button" class="btn-senha button-filter"
                                style="background-color: #34495e;"
                                data-id="{{ p.id }}"
                                data-email="{{ p.email_gestor }}">
                            Senha
                        </button>

                        <button type="button" class="button-danger btn-delete btn-deletar-parceiro"
                                data-id="{{ p.id }}"
                                data-nome-ajustado="{{ p.nome_ajustado }}">
                            Excluir 
                        </button>
                    </div>
                </td>

                <td style="text-align: center;">
                    {% if p.contrato_arquivo %}
                        <a href="{{ url_for('parceiro.baixar_contrato', filename=p.contrato_arquivo) }}" 
                        target="_blank" title="Visualizar Contrato" style="color: #c0392b; font-size: 1.2em;">
                            <i class="fas fa-file-pdf"></i>
                        </a>
                    {% else %}
                        <span style="color: #ccc;">-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>Nenhum parceiro cadastrado ainda.</p>
    {% endif %}

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;"> <h2>Editar Parceiro</h2>
            <form id="edit-form" method="post" class="filter-form" style="align-items: flex-start;" enctype="multipart/form-data">

                <div class="form-group" style="flex: 1.5;">
                    <label for="nome_fantasia_edit">Nome Fantasia: <span style="color: red;">*</label>
                    <input type="text" id="nome_fantasia_edit" name="nome_fantasia_edit" required>
                </div>

                <div class="form-group" style="flex: 1;">
                    <label for="tipo_edit">Tipo: <span style="color: red;">*</span></label>
                    <select id="tipo_edit" name="tipo_edit_disabled" required disabled
                        style="background-color: #eee; cursor: not-allowed;">
                        <option value="" disabled>Selecione...</option>
                        <option value="INDUSTRIA">INDUSTRIA</option>
                        <option value="DISTRIBUIDOR">DISTRIBUIDOR</option>
                    </select>
                    <input type="hidden" id="tipo_edit_hidden" name="tipo_edit">
                </div>

                <div class="form-group" style="flex: 1;">
                    <label for="cnpj_edit">CNPJ: <span style="color: red;">*</span></label>
                    <input type="text" id="cnpj_edit" name="cnpj_edit" required>
                </div>

                <div class="form-group" style="flex: 1.5;">
                    <label for="nome_ajustado_edit">Nome Ajustado: <span style="color: red;">*</span></label>
                    
                    <input type="text" id="nome_ajustado_edit" name="nome_ajustado_edit" required
                        list="datalist_nomes" autocomplete="off">
                </div>

                <div class="form-group" style="flex: 1.5;">
                    <label for="razao_social_edit">Razão Social: <span style="color: red;">*</span></label>
                    <input type="text" id="razao_social_edit" name="razao_social_edit" required>
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label for="gestor_edit">Gestor: <span style="color: red;">*</label>
                    <input type="text" id="gestor_edit" name="gestor_edit" required>
                </div>

                <div class="form-group" style="flex: 1;">
                    <label for="telefone_gestor_edit">Telefone Gestor: <span style="color: red;">*</label>
                    <input type="text" id="telefone_gestor_edit" name="telefone_gestor_edit" required>
                </div>

                <div class="form-group" style="flex: 1.5;">
                    <label for="email_gestor_edit">E-mail Gestor: <span style="color: red;">*</label>
                    <input type="email" id="email_gestor_edit" name="email_gestor_edit" readonly 
                           style="background-color: #eee; cursor: not-allowed;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="data_entrada_edit">Data Entrada: </label>
                    <input type="date" id="data_entrada_edit" name="data_entrada_edit">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="data_saida_edit">Data Saída: </span></label>
                    <input type="date" id="data_saida_edit" name="data_saida_edit">
                </div>

                <div class="form-group" style="flex: 100%;">
                    <label for="contrato_arquivo_edit">Alterar Contrato (PDF):</label>
                    <input type="file" id="contrato_arquivo_edit" name="contrato_arquivo_edit" accept=".pdf">

                    <p style="font-size: 12px; margin-top: 5px;">
                        Atual: <span id="contrato_atual_nome" style="font-weight: bold;">Nenhum</span>
                    </p>
                </div>

                <div id="container-remover-contrato" style="display: none; align-items: center; gap: 5px;">
                    <input type="checkbox" id="remover_contrato" name="remover_contrato" style="width: auto;">
                    <label for="remover_contrato" style="font-size: 13px; color: #c0392b; cursor: pointer;">
                        Remover contrato atual (deixar sem arquivo)
                    </label>
                </div>
                
                <div class="modal-actions" style="flex-basis: 100%; margin-top: 25px;">
                    <button id="modal-btn-cancel" type="button" class="modal-button-cancel">Cancelar</button>
                    <button type="submit" class="modal-button-confirm">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="senha-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="senha-modal-btn-close">&times;</span>
            <h2>Definir Nova Senha</h2> 

            <p>Você está definindo uma nova senha para o usuário:</p>
            <p class="delete-modal-parceiro-name-label" style="border-color: #34495e;">
                Email: <strong id="senha-modal-email" style="color: #34495e;"></strong>
            </p>
            <p>A senha deverá ter pelo menos:</p>

            <ul>
                <li>Mínimo de 6 caracteres</li>
                <li>Uma Letra Maiscúla</li>
                <li>Um Caracter especial (@#$.%)</li>
            </ul> 

            <form id="senha-form" method="post" action="">
                <div class="form-group" style="text-align: left; margin-top: 15px;">
                    <label for="nova_senha">Nova Senha:</label>
                    <input type="password" id="nova_senha" name="nova_senha" required>
                </div>

                <div class="form-group" style="text-align: left; margin-top: 15px;">
                    <label for="confirmar_senha">Confirmar Senha:</label>
                    <input type="password" id="confirmar_senha" name="confirmar_senha" required>
                </div>

                <div class="modal-actions" style="margin-top: 25px;">
                    <button id="senha-modal-btn-cancel" type="button" class="modal-button-cancel">Cancelar</button>
                    <button id="senha-modal-btn-confirm" type="submit" class="modal-button-confirm" style="background-color: #34495e;">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Confirmar Exclusão</h2> 
            
            <p>Para habilitar a confirmação, digite o nome ajustado exato do parceiro no campo abaixo:</p>

            <p class="delete-modal-parceiro-name-label">Nome Ajustado: <strong id="delete-modal-parceiro-name"></strong></p>

            <form id="delete-form" method="post" action="">
                <div class="form-group" style="text-align: left; margin-top: 15px;">
                    <label for="delete-modal-input">Digite o nome para confirmar:</label>
                    <input type="text" id="delete-modal-input" name="confirmation_text" autocomplete="off">
                </div>
                
                <div class="form-group" style="text-align: left; margin-top: 15px;">
                    <label for="delete-modal-password">Senha de Confirmação:</label>
                    <input type="password" id="delete-modal-password" name="confirmation_password" autocomplete="off">
                </div>

                <p class="delete-modal-info-text">(Isso irá excluir permanentemente o parceiro.)</p>
                
                <div class="modal-actions" style="margin-top: 25px;">
                    <button id="delete-modal-btn-cancel" type="button" class="modal-button-cancel">Cancelar</button>
                    <button id="delete-modal-btn-confirm" type="submit" class="modal-button-danger" disabled>Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="create-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="create-modal-btn-close">&times;</span>
            <h2>Confirmar Criação de Parceiro</h2> 
            
            <p>O e-mail gestor a ser cadastrado é:</p>
            <p class="delete-modal-parceiro-name-label" style="border-color: #3498db;">
                Email: <strong id="create-modal-email" style="color: #3498db;"></strong>
            </p>
            <p class="delete-modal-info-text" style="color: #c0392b; font-weight: bold;">
                Atenção: A criação de um novo parceiro gera uma taxa na plataforma Embedded.
            </p>
            <p class="delete-modal-info-text" style="margin-top: -10px;">
                O e-mail não poderá ser alterado após a criação.
            </p>
            <br>

            <div class="modal-actions" style="margin-top: 25px;">
                <button id="create-modal-btn-cancel" type="button" class="modal-button-cancel">Cancelar</button>
                <button id="create-modal-btn-confirm" type="button" class="modal-button-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <datalist id="datalist_nomes">
        {% for nome in lista_nomes_ajustados %}
            <option value="{{ nome }}">
        {% endfor %}
    </datalist>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='parceiro/js/parceirosPage.js') }}"></script>
{% endblock %}