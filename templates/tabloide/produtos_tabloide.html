{% extends "tabloide/base_tabloide.html" %}

{% block title %}Produtos do Tabloide{% endblock %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='tabloide/css/page-tabloide.css') }}">
{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Gerenciar Produtos do Tabloide: <br> {{ tabloide.nome }}</h1>

        <div style="display: flex; gap: 15px; align-items: center;">
            <div>
                <a href="{{ url_for('tabloide.download_modelo') }}" class="button-filter" style="margin: 0; max-width: 250px; text-decoration: none;">
                    &#x2B07; Baixar Modelo da Planilha
                </a>
            </div>

            <button type="button" id="btn-export-excel" class="button-filter" style="flex: 1; background-color: #27ae60; min-width: 150px; margin: 0;">
                Exportar Excel (.xlsx)
            </button>
        </div>
    </div>
    
    <a href="{{ url_for('tabloide.gestao_tabloides') }}" style="display: inline-block; margin-bottom: 20px;">&larr; Voltar para Tabloides</a>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h2>Produtos Cadastrados</h2>
    {% if produtos %}
    <form method="post" id="form-edit-delete">
        <table>
            <thead>
                <tr>
                    <th style="width: 5%; text-align: center;">
                         <input type="checkbox" id="select-all-checkbox" title="Selecionar Todos">
                    </th>
                    <th style="width: 12%;">Cód. Barras</th>
                    <th>Descrição</th>
                    <th style="width: 10%;">Laboratório</th>
                    <th style="width: 9%;">Tipo Preço</th>
                    <th style="width: 9%;">Preço Normal</th>
                    <th style="width: 9%;">Preço Geral</th>
                    <th style="width: 9%;">Preço Cliente+</th>
                    <th style="width: 8%;">Tipo Regra</th>               
                    <th style="width: 9%;">Preço App</th>                
                </tr>
            </thead>
            <tbody>
                {% for p in produtos %}
                <tr>
                    <td style="text-align: center;">
                        <input type="checkbox" name="selecionado" value="{{ p.id }}" class="edit-checkbox">
                    </td>
                    <td><input type="text" name="codigo_barras_{{ p.id }}" value="{{ p.codigo_barras or '' }}" disabled class="barcode-input"></td>
                    <td class="assunto-cell"><input type="text" name="descricao_{{ p.id }}" value="{{ p.descricao or '' }}" disabled></td> 
                    <td><input type="text" name="laboratorio_{{ p.id }}" value="{{ p.laboratorio or '' }}" disabled></td>
                    <td><input type="text" name="tipo_preco_{{ p.id }}" value="{{ p.tipo_preco or '' }}" disabled></td>
                    <td><input type="number" step="0.01" name="preco_normal_{{ p.id }}" value="{{ p.preco_normal or '' }}" disabled></td>
                    <td><input type="number" step="0.01" name="preco_desconto_{{ p.id }}" value="{{ p.preco_desconto or '' }}" disabled></td>
                    <td><input type="number" step="0.01" name="preco_desconto_cliente_{{ p.id }}" value="{{ p.preco_desconto_cliente or '' }}" disabled></td>
                    <td><input type="text" name="tipo_regra_{{ p.id }}" value="{{ p.tipo_regra or '' }}" disabled></td>          
                    <td><input type="number" step="0.01" name="preco_app_{{ p.id }}" value="{{ p.preco_app or '' }}" disabled></td> 
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div style="display: flex; gap: 10px; align-items: flex-start; margin-top: 20px;">
            
            <div class="button-wrapper">
                <button type="submit" formaction="{{ url_for('tabloide_produtos.atualizar_produtos', tabloide_id=tabloide.id) }}">Salvar Alterações</button>
            </div>
            
            <div class="button-wrapper">
                <p class="button-description-text">Valida se o desconto é menor que o preço normal</p>
                <button type="button" id="btn-validar-formato" class="button-filter">Validar Formato</button>
            </div>

            <div class="button-wrapper">
                <p class="button-description-text">Valida se está cadastrado no plugpharma com GTIN principal</p>
                <button type="button" id="btn-validar-gtins" class="button-filter" style="background-color: #f39c12;">Validar GTINs</button>
            </div>

            <div class="button-wrapper">
                <button type="button" id="btn-limpar-validacoes" class="button-filter" style="background-color: #312f2f;">Limpar Validações</button>
            </div>
            
            <div class="button-wrapper">
                <button type="button" id="btn-show-delete-bulk-modal" class="button-danger" 
                        disabled 
                        data-delete-action="{{ url_for('tabloide_produtos.deletar_produtos', tabloide_id=tabloide.id) }}">
                    Deletar Selecionados
                </button>
            </div>
        </div>
    </form>
    {% else %}
    <p>Nenhum produto cadastrado.</p>
    {% endif %}

    <hr style="margin: 40px 0;">

    <h2>Adicionar Novo Produto</h2>
    <div class="filter-container">
        <form action="{{ url_for('tabloide_produtos.adicionar_produto', tabloide_id=tabloide.id) }}" method="post" class="filter-form">
            <div class="form-group" style="flex: 1.5 1 180px;">
                <label>Cód. Barras:</label>
                <input type="text" name="codigo_barras">
            </div>
            <div class="form-group" style="flex: 3 1 500px;">
                <label>Descrição:</label>
                <input type="text" name="descricao">
            </div>
            <div class="form-group" style="flex: 1.5 1 180px;">
                <label>Laboratório:</label>
                <input type="text" name="laboratorio">
            </div>
            <div class="form-group" style="flex: 1.5 1 180px;">
                <label>Tipo de Preço:</label>
                <select name="tipo_preco">
                    <option value="">Selecione...</option>
                    <option value="Liberado">Liberado</option>
                    <option value="Monitorado">Monitorado</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Preço Normal:</label>
                <input type="number" step="0.01" name="preco_normal">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Preço Geral:</label>
                <input type="number" step="0.01" name="preco_desconto">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Preço Cliente+:</label>
                <input type="number" step="0.01" name="preco_desconto_cliente">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Tipo Regra:</label>
                <select name="tipo_regra">
                    <option value="">Selecione...</option>
                    <option value="Normal">Normal</option>
                    <option value="Multiplo">Multiplo</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Preço APP:</label>
                <input type="number" step="0.01" name="preco_app">
            </div>
            <button type="submit" class="button-filter">Adicionar</button>
        </form>
    </div>

    <div id="delete-bulk-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="delete-bulk-modal-btn-close">&times;</span>
            <h2>Confirmação de Exclusão</h2>
            <p>Você está prestes a <strong>deletar permanentemente</strong> <br> <span id="delete-bulk-modal-count">0</span> produto(s) selecionado(s). <br> Esta ação é irreversível.</p>

            <form id="delete-bulk-form" method="post">
                <div class="form-group" style="text-align: left; margin-top: 15px;">
                    <label for="delete-bulk-modal-password">Senha de Confirmação:</label>
                    <input type="password" id="delete-bulk-modal-password" name="confirmation_password_bulk" autocomplete="off" required>
                </div>
                <div class="modal-actions">
                    <button type="button" id="delete-bulk-modal-btn-cancel" class="button-filter">Cancelar</button>
                    <button type="submit" id="delete-bulk-modal-btn-confirm" class="button-danger" disabled>Confirmar</button>
                </div>
            </form>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="{{ url_for('static', filename='core/js/productTableUtils.js') }}"></script>
    <script src="{{ url_for('static', filename='core/js/selectAll.js') }}"></script>
    <script src="{{ url_for('static', filename='tabloide/js/produtosTabloidePage.js') }}"></script>
{% endblock %}