{% extends "tabloide/base_tabloide.html" %}

{% block title %}Produtos do Tabloide{% endblock %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/page-tabloide.css') }}">
{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Gerenciar Produtos do Tabloide: {{ tabloide.nome }}</h1>

        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button type="button" id="btn-export-excel" class="button-filter" style="flex: 1; background-color: #27ae60; min-width: 150px;">
                Exportar Excel
            </button>
        </div>
    </div>
    <a href="{{ url_for('tabloide.gestao_tabloides') }}" style="display: inline-block; margin-bottom: 20px;">&larr; Voltar para Tabloides</a>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h2>Produtos Cadastrados</h2>
    {% if produtos %}
    <form method="post" id="form-edit-delete">
        <table>
            <thead>
                <tr>
                    <th style="width: 5%;">Editar?</th>
                    <th style="width: 12%;">Cód. Barras</th>
                    <th>Descrição</th>
                    <th style="width: 12%;">Laboratório</th>
                    <th style="width: 10%;">Preço Normal</th>
                    <th style="width: 10%;">Preço Geral</th>
                    <th style="width: 10%;">Preço Cliente+</th>
                    <th style="width: 10%;">Preço App</th>
                    <th style="width: 8%;">Tipo Regra</th>
                </tr>
            </thead>
            <tbody>
                {% for p in produtos %}
                <tr>
                    <td style="text-align: center;">
                        <input type="checkbox" name="selecionado" value="{{ p.id }}" class="edit-checkbox">
                    </td>
                    <td><input type="text" name="codigo_barras_{{ p.id }}" value="{{ p.codigo_barras or '' }}" disabled class="barcode-input"></td>
                    <td class="assunto-cell"><input type="text" name="descricao_{{ p.id }}" value="{{ p.descricao or '' }}" disabled></td> 
                    <td><input type="text" name="laboratorio_{{ p.id }}" value="{{ p.laboratorio or '' }}" disabled></td>
                    <td><input type="number" step="0.01" name="preco_normal_{{ p.id }}" value="{{ p.preco_normal or '' }}" disabled></td>
                    <td><input type="number" step="0.01" name="preco_desconto_{{ p.id }}" value="{{ p.preco_desconto or '' }}" disabled></td>
                    <td><input type="number" step="0.01" name="preco_desconto_cliente_{{ p.id }}" value="{{ p.preco_desconto_cliente or '' }}" disabled></td>
                    <td><input type="number" step="0.01" name="preco_app_{{ p.id }}" value="{{ p.preco_app or '' }}" disabled></td>
                    <td><input type="text" name="tipo_regra_{{ p.id }}" value="{{ p.tipo_regra or '' }}" disabled></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
            <button type="submit" formaction="{{ url_for('tabloide_produtos.atualizar_produtos', campanha_id=tabloide.id) }}" style="flex: 1; min-width: 150px;">Salvar Alterações</button>
            <button type="button" id="btn-validar-formato" class="button-filter" style="flex: 1; min-width: 150px;">Validar Formato</button>
            <button type="button" id="btn-validar-gtins" class="button-filter" style="flex: 1; background-color: #f39c12; min-width: 150px;">Validar GTINs</button>
            <button type="button" id="btn-limpar-validacoes" class="button-filter" style="flex: 1; background-color: #d1f312; min-width: 150px;">Limpar Validações</button>
            <button type="submit" formaction="{{ url_for('tabloide_produtos.deletar_produtos', campanha_id=tabloide.id) }}" class="button-danger" style="flex: 1; margin: 0; max-width: none; min-width: 150px;" onclick="return confirm('Tem certeza?');">Deletar</button>
        </div>
    </form>
    {% else %}
    <p>Nenhum produto cadastrado.</p>
    {% endif %}

    <hr style="margin: 40px 0;">

    <h2>Adicionar Novo Produto</h2>
    <div class="filter-container">
        <form action="{{ url_for('tabloide_produtos.adicionar_produto', campanha_id=tabloide.id) }}" method="post" class="filter-form">
            <div class="form-group" style="flex: 1.5;">
                <label>Cód. Barras:</label>
                <input type="text" name="codigo_barras">
            </div>
            <div class="form-group" style="flex: 3;">
                <label>Descrição:</label>
                <input type="text" name="descricao">
            </div>
            <div class="form-group" style="flex: 1.5;">
                <label>Laboratório:</label>
                <input type="text" name="laboratorio">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Preço Normal:</label>
                <input type="number" step="0.01" name="preco_normal">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Preço Geral:</label>
                <input type="number" step="0.01" name="preco_desconto">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Preço Cliente+:</label>
                <input type="number" step="0.01" name="preco_desconto_cliente">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Preço APP:</label>
                <input type="number" step="0.01" name="preco_app">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Tipo Regra:</label>
                <input type="text" name="tipo_regra">
            </div>
            <button type="submit" class="button-filter">Adicionar</button>
        </form>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="{{ url_for('static', filename='js/productTableUtils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/produtosTabloidePage.js') }}"></script>
{% endblock %}